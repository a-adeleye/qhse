<div class="start-container">
  <div class="spacer"></div>
  <div class="secondary-header">
    <div class="progress-container">
      <div class="progress-bar">
        <div [style.width.%]="getProgress()" class="progress-fill"></div>
      </div>
      <p class="q-subtitle">{{ getCompletedCount() }} of {{ questions.length }} completed</p>
    </div>
    <div [class]="isOnline ? 'online' : 'offline'" class="connectivity-status"
         matTooltip="{{ isOnline ? 'You are online' : 'You are offline - forms will be saved locally' }}"
         matTooltipPosition="below">
      <mat-icon class="status-icon">
        {{ isOnline ? 'wifi' : 'wifi_off' }}
      </mat-icon>
      <span class="status-text">
                  {{ isOnline ? 'Online' : 'Offline' }}
                </span>
    </div>
  </div>
  <form (ngSubmit)="submit()" [formGroup]="form" class="form-wrap" enctype="multipart/form-data">
    <mat-card class="q-card">
      <div class="q-header">
        <div class="header-content">
          <button (click)="goBack()" class="back-btn" mat-icon-button type="button">
            <mat-icon>arrow_back</mat-icon>
          </button>

          <div class="header-text">
            <div class="header-main">
              <h1 class="q-title">{{ listName }}</h1>
            </div>
          </div>

          <button [disabled]="form.invalid || isSubmitting" class="submit-btn" color="primary" mat-flat-button
                  type="submit">
            @if (isSubmitting) {
              <mat-spinner class="submit-spinner" diameter="20"></mat-spinner>
            }
            @if (isOnline && !isSubmitting) {
              <span>Submit</span>
            }
            @if (!isOnline && !isSubmitting) {
              <span>Save Locally</span>
            }
          </button>
        </div>
      </div>

      <div class="q-list">
        <div class="q-item">
          <div class="q-text">Date of Inspection <span class="required">*</span></div>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select date</mat-label>
            <input
              [matDatepicker]="picker"
              formControlName="DateofInspection"
              matInput
              placeholder="MM/DD/YYYY"/>
            <mat-datepicker-toggle [for]="picker" matSuffix></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="q-item" style="display: flex; align-items: center; gap: 2em;">
          <div class="q-text" style="margin-bottom: 0;">Shift <span class="required">*</span></div>
          <div class="choice-group" style="margin-top: 0;">
            <mat-radio-group class="radio-group" formControlName="Shift">
              <mat-radio-button class="radio-btn" value="Morning">Morning</mat-radio-button>
              <mat-radio-button class="radio-btn" value="Night">Night</mat-radio-button>
            </mat-radio-group>
          </div>
        </div>

        @for (q of questions; track q.id; let i = $index) {
          <div class="q-item">
            <div class="q-text">
              <span class="question-number">{{ i + 1 }}.</span>
              {{ q.title }}
              @if (isRequired(q.id)) {
                <span class="required">*</span>
              }
            </div>

            @if (q.type === 'Choice') {
              <div class="choice-group">
                <mat-radio-group [formControlName]="q.id" class="radio-group">
                  @if (q.options?.length) {
                    @for (option of q.options; track $index) {
                      <mat-radio-button class="radio-btn" value="{{ option }}">
                        <span [ngClass]="
                        {'all-ok': $index === 0,
                        'unserviceable': $index === 1,
                        'needs-attention': $index === 2
                        }" class="badge">{{ option }}</span>
                      </mat-radio-button>
                    }
                  } @else {
                    <mat-radio-button class="radio-btn" value="Yes">
                      <span class="badge all-ok">Yes</span>
                    </mat-radio-button>
                    <mat-radio-button class="radio-btn" value="No">
                      <span class="badge unserviceable">No</span>
                    </mat-radio-button>
                  }
                </mat-radio-group>
              </div>
            }

            @if (q.type === 'FleetNumber') {
              <div class="choice-group fleet-number-group">
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Select Fleet Number</mat-label>
                  <mat-select [formControlName]="q.id">
                    @for (fleetNumber of fleetNumbers; track fleetNumber) {
                      <mat-option [value]="fleetNumber">{{ fleetNumber }}</mat-option>
                    }
                  </mat-select>
                </mat-form-field>
              </div>
            }

            @if (q.type === 'Condition') {
              <div class="condition-group">
                <mat-radio-group [formControlName]="q.id" class="radio-group vertical">
                  <mat-radio-button class="radio-btn ok" value="All Ok">
                    <span class="badge all-ok">All Ok</span>
                  </mat-radio-button>
                  <mat-radio-button class="radio-btn attention" value="Needs Attention">
                    <span class="badge needs-attention">Needs Attention</span>
                  </mat-radio-button>
                  <mat-radio-button class="radio-btn bad" value="Unserviceable">
                    <span class="badge unserviceable">Unserviceable</span>
                  </mat-radio-button>
                </mat-radio-group>
              </div>
            }

            @if (q.type === 'Single_line_of_text') {
              <mat-form-field appearance="outline" class="full-width">
                <input [formControlName]="q.id" matInput placeholder="Type"/>
              </mat-form-field>
            }

            @if (q.type === 'multi_line_of_text') {
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>{{ q.title }}</mat-label>
                <textarea [formControlName]="q.id" matInput placeholder="Enter {{ q.title }}" rows="3"></textarea>
              </mat-form-field>
            }

            @if (q.type === 'Date_and_Time') {
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Select date</mat-label>
                <input
                  [formControlName]="q.id"
                  [matDatepicker]="picker"
                  matInput
                  placeholder="MM/DD/YYYY"/>
                <mat-datepicker-toggle [for]="picker" matSuffix></mat-datepicker-toggle>
                <mat-datepicker #picker></mat-datepicker>
              </mat-form-field>
            }
          </div>
        }

        <div class="q-item">
          <div class="q-text">
            <span class="question-number">{{ questions.length + 1 }}.</span> Overall Condition <span
            class="required">*</span>
          </div>
          <div class="condition-group">
            <mat-radio-group class="radio-group vertical" formControlName="OverallCondition">
              <mat-radio-button class="radio-btn ok" value="All Ok">
                <span class="badge all-ok">All Ok</span>
              </mat-radio-button>
              <mat-radio-button class="radio-btn attention" value="Needs Attention">
                <span class="badge needs-attention">Needs Attention</span>
              </mat-radio-button>
              <mat-radio-button class="radio-btn bad" value="Unserviceable">
                <span class="badge unserviceable">Unserviceable</span>
              </mat-radio-button>
            </mat-radio-group>
          </div>
        </div>

        <div class="q-item">
          <div class="q-text">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Remarks</mat-label>
              <textarea formControlName="Remarks" matInput placeholder="Enter Remarks" rows="3"></textarea>
            </mat-form-field>
          </div>
        </div>

        <div class="q-item">
          <div class="q-text">Attach Supporting Documents or Photos
            <span class="optional">(Optional)</span>
          </div>

          <div class="attachment-group">
            <input
              #fileInput
              (change)="onFileSelected($event)"
              accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
              class="file-input"
              id="attachmentInput"
              type="file"
            />
            <label class="file-input-label" for="attachmentInput">
              <mat-icon class="attach-icon">attach_file</mat-icon>
              <span>Choose Files</span>
            </label>

            @if (selectedFiles.length > 0) {
              <div class="selected-files">
                <h4>Selected Files :</h4>
                <div class="file-list">
                  @for (file of selectedFiles; track file.name; let i = $index) {
                    <div class="file-item">
                      <mat-icon class="file-icon">description</mat-icon>
                      <span class="file-name">{{ file.name }}</span>

                      <div class="file-actions">
                        <span class="file-size">({{ formatFileSize(file.size) }})</span>
                        <button
                          (click)="removeFile(i)"
                          class="remove-file-btn"
                          mat-icon-button
                          type="button"
                        >
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <div class="file-requirements">
              <small>Supported formats: Images, PDF, Word, Excel. Max file size: 10MB each.</small>
            </div>
          </div>
        </div>
      </div>

      <div class="mobile-spacer"></div>
    </mat-card>

    <div class="mobile-actions">
      <button [disabled]="form.invalid || isSubmitting" class="mobile-submit-btn" color="primary" mat-flat-button
              type="submit">
        @if (isSubmitting) {
          <mat-spinner class="submit-spinner" diameter="20"></mat-spinner>
        }
        @if (isOnline && !isSubmitting) {
          <span>Submit Inspection</span>
        }
        @if (!isOnline && !isSubmitting) {
          <span>Save Locally</span>
        }
      </button>
    </div>
  </form>
</div>

@if (loading) {
  <app-loading/>
}
